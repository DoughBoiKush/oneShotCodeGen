# Backend Code

{
"files":{
"backend/.env":"PORT=3000\nDB_PATH=pizzatracker.sqlite\nJWT_SECRET=your-super-secret-jwt-key",
"backend/models/index.js":"const { Sequelize } = require('sequelize');const path = require('path');const sequelize = new Sequelize({dialect: 'sqlite',storage: process.env.DB_PATH});const db = {};db.sequelize = sequelize;db.User = require('./user')(sequelize);db.PizzaPlace = require('./pizzaPlace')(sequelize);db.Review = require('./review')(sequelize);db.Consumption = require('./consumption')(sequelize);db.User.hasMany(db.Review);db.Review.belongsTo(db.User);db.User.hasMany(db.Consumption);db.Consumption.belongsTo(db.User);db.PizzaPlace.hasMany(db.Review);db.Review.belongsTo(db.PizzaPlace);db.PizzaPlace.hasMany(db.Consumption);db.Consumption.belongsTo(db.PizzaPlace);module.exports = db;",
"backend/models/user.js":"const { DataTypes } = require('sequelize');module.exports = (sequelize) => {return sequelize.define('User', {id: {type: DataTypes.INTEGER,primaryKey: true,autoIncrement: true},email: {type: DataTypes.STRING,unique: true,allowNull: false},password: {type: DataTypes.STRING,allowNull: false},name: {type: DataTypes.STRING,allowNull: false},isAdmin: {type: DataTypes.BOOLEAN,defaultValue: false}})};",
"backend/models/pizzaPlace.js":"const { DataTypes } = require('sequelize');module.exports = (sequelize) => {return sequelize.define('PizzaPlace', {id: {type: DataTypes.INTEGER,primaryKey: true,autoIncrement: true},name: {type: DataTypes.STRING,allowNull: false},address: {type: DataTypes.STRING,allowNull: false},phone: DataTypes.STRING,website: DataTypes.STRING,averageRating: {type: DataTypes.FLOAT,defaultValue: 0}})};",
"backend/models/review.js":"const { DataTypes } = require('sequelize');module.exports = (sequelize) => {return sequelize.define('Review', {id: {type: DataTypes.INTEGER,primaryKey: true,autoIncrement: true},rating: {type: DataTypes.INTEGER,allowNull: false},comment: DataTypes.TEXT})};",
"backend/models/consumption.js":"const { DataTypes } = require('sequelize');module.exports = (sequelize) => {return sequelize.define('Consumption', {id: {type: DataTypes.INTEGER,primaryKey: true,autoIncrement: true},slices: {type: DataTypes.INTEGER,allowNull: false},date: {type: DataTypes.DATE,defaultValue: DataTypes.NOW}})};",
"backend/config/database.js":"const db = require('../models');const bcrypt = require('bcryptjs');async function initDatabase() {try {await db.sequelize.sync({ force: true });const adminUser = await db.User.create({email: 'user@example.com',password: bcrypt.hashSync('test123', 8),name: 'Admin User',isAdmin: true});const pizzaPlace = await db.PizzaPlace.create({name: 'Pizza Heaven',address: '123 Main St',phone: '555-0123',website: 'www.pizzaheaven.com'});await db.Review.create({rating: 5,comment: 'Best pizza ever!',UserId: adminUser.id,PizzaPlaceId: pizzaPlace.id});await db.Consumption.create({slices: 3,UserId: adminUser.id,PizzaPlaceId: pizzaPlace.id});} catch (error) {console.error('Database initialization error:', error);}};module.exports = { initDatabase };",
"backend/middleware/auth.js":"const jwt = require('jsonwebtoken');const auth = (req, res, next) => {try {const token = req.headers.authorization?.split(' ')[1];if (!token) return res.status(401).json({ message: 'No token provided' });const decoded = jwt.verify(token, process.env.JWT_SECRET);req.userId = decoded.id;next();} catch (error) {return res.status(401).json({ message: 'Invalid token' });}};const isAdmin = async (req, res, next) => {try {const user = await require('../models').User.findByPk(req.userId);if (!user.isAdmin) return res.status(403).json({ message: 'Requires admin access' });next();} catch (error) {return res.status(500).json({ message: 'Server error' });}};module.exports = { auth, isAdmin };",
"backend/controllers/auth.js":"const db = require('../models');const bcrypt = require('bcryptjs');const jwt = require('jsonwebtoken');exports.login = async (req, res) => {try {const user = await db.User.findOne({ where: { email: req.body.email }});if (!user || !bcrypt.compareSync(req.body.password, user.password)) return res.status(401).json({ message: 'Invalid credentials' });const token = jwt.sign({ id: user.id }, process.env.JWT_SECRET, { expiresIn: '24h' });res.json({ token, user: { id: user.id, email: user.email, name: user.name, isAdmin: user.isAdmin }});} catch (error) {res.status(500).json({ message: 'Server error' });}};exports.register = async (req, res) => {try {const user = await db.User.create({...req.body,password: bcrypt.hashSync(req.body.password, 8)});const token = jwt.sign({ id: user.id }, process.env.JWT_SECRET, { expiresIn: '24h' });res.status(201).json({ token, user: { id: user.id, email: user.email, name: user.name, isAdmin: user.isAdmin }});} catch (error) {res.status(500).json({ message: 'Server error' })}};",
"backend/controllers/pizzaPlace.js":"const db = require('../models');exports.getAllPlaces = async (req, res) => {try {const places = await db.PizzaPlace.findAll({include: [{model: db.Review, include: [{model: db.User, attributes: ['name']}]}]});res.json(places);} catch (error) {res.status(500).json({ message: 'Server error' });}};exports.createPlace = async (req, res) => {try {const place = await db.PizzaPlace.create(req.body);res.status(201).json(place);} catch (error) {res.status(500).json({ message: 'Server error' });}};exports.updatePlace = async (req, res) => {try {const place = await db.PizzaPlace.findByPk(req.params.id);if (!place) return res.status(404).json({ message: 'Place not found' });await place.update(req.body);res.json(place);} catch (error) {res.status(500).json({ message: 'Server error' });}};",
"backend/controllers/review.js":"const db = require('../models');exports.createReview = async (req, res) => {try {const review = await db.Review.create({...req.body,UserId: req.userId});res.status(201).json(review);} catch (error) {res.status(500).json({ message: 'Server error' });}};exports.getReviews = async (req, res) => {try {const reviews = await db.Review.findAll({include: [{model: db.User, attributes: ['name']},{model: db.PizzaPlace, attributes: ['name']}]});res.json(reviews);} catch (error) {res.status(500).json({ message: 'Server error' });}};",
"backend/controllers/consumption.js":"const db = require('../models');exports.logConsumption = async (req, res) => {try {const consumption = await db.Consumption.create({...req.body,UserId: req.userId});res.status(201).json(consumption);} catch (error) {res.status(500).json({ message: 'Server error' });}};exports.getStats = async (req, res) => {try {const stats = await db.Consumption.findAll({where: { UserId: req.userId },include: [{model: db.PizzaPlace, attributes: ['name']}]});res.json(stats);} catch (error) {res.status(500).json({ message: 'Server error' });}};",
"backend/routes/auth.js":"const router = require('express').Router();const authController = require('../controllers/auth');router.post('/login', authController.login);router.post('/register', authController.register);module.exports = router;",
"backend/routes/pizzaPlace.js":"const router = require('express').Router();const pizzaPlaceController = require('../controllers/pizzaPlace');const { auth } = require('../middleware/auth');router.use(auth);router.get('/', pizzaPlaceController.getAllPlaces);router.post('/', pizzaPlaceController.createPlace);router.put('/:id', pizzaPlaceController.updatePlace);module.exports = router;",
"backend/routes/review.js":"const router = require('express').Router();const reviewController = require('../controllers/review');const { auth } = require('../middleware/auth');router.use(auth);router.get('/', reviewController.getReviews);router.post('/', reviewController.createReview);module.exports = router;",
"backend/routes/consumption.js":"const router = require('express').Router();const consumptionController = require('../controllers/consumption');const { auth } = require('../middleware/auth');router.use(auth);router.post('/', consumptionController.logConsumption);router.get('/stats', consumptionController.getStats);module.exports = router;",
"backend/server.js":"require('dotenv').config();const express = require('express');const cors = require('cors');const { initDatabase } = require('./config/database');const app = express();app.use(cors());app.use(express.json());app.use('/api/auth', require('./routes/auth'));app.use('/api/places', require('./routes/pizzaPlace'));app.use('/api/reviews', require('./routes/review'));app.use('/api/consumption', require('./routes/consumption'));initDatabase().then(() => {app.listen(process.env.PORT, () => console.log(`Server running on port ${process.env.PORT}`));});"
},
"commands":["mkdir backend","cd backend && npm init -y","cd backend && npm install express sequelize sqlite3 bcryptjs jsonwebtoken cors dotenv"]
}